name: Testing

on: [push, pull_request]

jobs:
    backend:
        name: Backend testing
        runs-on: ubuntu-22.04
        environment: test
        env:
            POSTGRES_DB: ${{ vars.TEST_POSTGRES_DB }}
            POSTGRES_USER: ${{ vars.TEST_POSTGRES_USER }}
            POSTGRES_PASSWORD: ${{ vars.TEST_POSTGRES_PASSWORD }}
        steps:
            - name: echos github.event variable
              run: |
                echo "github.event.workflow_run.head_sha:"
                echo ${{ github.event.workflow_run.head_sha }}
                echo "github.event.workflow_run.head_branch:"
                echo ${{ github.event.workflow_run.head_branch }}
                echo "github.event:"
                echo ${{ github.event }}
            - uses: actions/checkout@v3
            # TBD: This is building both backend and frontend! move build to a separate job and reuse the image
            # make backend and frontend testing dependend on the build stage!
            # this way backend and frontend can be tested in parallel
            - name: Build
              run: docker compose -f compose.yml -f compose.override.test.yml build
            - name: Code Formating
              run: docker compose -f compose.yml -f compose.override.test.yml run --rm backend_api sh -c "black --check ."
            - name: Linting
              run: docker compose -f compose.yml -f compose.override.test.yml run --rm backend_api sh -c "ruff check ."
            # - name: Unit testing
            #   run: docker compose -f compose.yml -f compose.override.test.yml run --rm backend_api sh -c "pytest"
        
    # frontend:
    #     name: Frontend testing
    #     runs-on: ubuntu-22.04
    #     environment: test
    #     steps:
    #         - uses: actions/checkout@v3
            # - name: Build
            #   run: docker compose -f compose.yml -f compose.override.test.yml build
            # - name: Code Formating
            #   run: docker compose -f compose.yml -f compose.override.test.yml run --rm frontend sh -c "npm run lint"
